(window.webpackJsonp=window.webpackJsonp||[]).push([[102],{422:function(e,t,r){"use strict";r.r(t);var a=r(10),s=Object(a.a)({},(function(){var e=this,t=e._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("p",[e._v("On 8th of August, Kevin Joensen, a researcher at "),t("a",{attrs:{href:"https://www.doyensec.com/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Doyensec"),t("OutboundLink")],1),e._v(", contacted our core contributors and responsibly disclosed a vulnerability found in BTCPay Server.")]),e._v(" "),t("h2",{attrs:{id:"impact"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#impact"}},[e._v("#")]),e._v(" Impact")]),e._v(" "),t("p",[t("strong",[e._v("Impacted")]),e._v(" - Third-party hosts. Users that enabled registration for other users and are hosting their server to an unknown, potentially malicious actor.")]),e._v(" "),t("p",[t("strong",[e._v("Not impacted")]),e._v(" - Regular, self-hosted instances. Users that don't allow registration to unknown, potentially malicious actors.")]),e._v(" "),t("h2",{attrs:{id:"how-to-fix-it"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#how-to-fix-it"}},[e._v("#")]),e._v(" How to fix it")]),e._v(" "),t("p",[t("strong",[e._v("There is no evidence that the vulnerability has been exploited in practice. However, we encourage the impacted users to update their servers.")])]),e._v(" "),t("p",[e._v("We patched the potential vulnerability in version "),t("a",{attrs:{href:"https://blog.btcpayserver.org/btcpay-1-0-3-127-released",target:"_blank",rel:"noopener noreferrer"}},[e._v("1.0.3.127"),t("OutboundLink")],1),e._v(". To mitigate, "),t("a",{attrs:{href:"https://docs.btcpayserver.org/faq-and-common-issues/faq-serversettings#how-to-update-btcpay-server",target:"_blank",rel:"noopener noreferrer"}},[e._v("update"),t("OutboundLink")],1),e._v(" your server to version 1.0.3.127 or above.")]),e._v(" "),t("h3",{attrs:{id:"attack-vector"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#attack-vector"}},[e._v("#")]),e._v(" Attack Vector")]),e._v(" "),t("p",[e._v("Several "),t("a",{attrs:{href:"https://en.wikipedia.org/wiki/Cross-site_scripting",target:"_blank",rel:"noopener noreferrer"}},[e._v("XSS"),t("OutboundLink")],1),e._v(" issues were present in BTCPay Server where a malicious merchant could create a page which would leak the private SSH key of the host if the host was browsing the infected page.")]),e._v(" "),t("p",[e._v("BTCPay Server has three types of users:")]),e._v(" "),t("ul",[t("li",[e._v("Host (Admin)")]),e._v(" "),t("li",[e._v("Merchant (Users)")]),e._v(" "),t("li",[e._v("Customers (Users paying to a merchant)")])]),e._v(" "),t("p",[e._v("If you self-host BTCPay Server, then you are at the same time a host and a merchant. If you are a "),t("a",{attrs:{href:"https://docs.btcpayserver.org/deployment/thirdpartyhosting",target:"_blank",rel:"noopener noreferrer"}},[e._v("third party host provider"),t("OutboundLink")],1),e._v(", host and merchant are not the same user, because you're allowing other users to register and use your instance.")]),e._v(" "),t("p",[e._v("The vulnerability "),t("strong",[e._v("influences only third-party hosts")]),e._v(", that enabled registration for the "),t("strong",[e._v("untrusted")]),e._v(" users in Server Settings > Policies and their users. The registration for other users is "),t("strong",[e._v("disabled by default")]),e._v(" when BTCPay Server is deployed.")]),e._v(" "),t("p",[e._v("This vulnerability can only be leveraged by a malicious merchant and target the host, in the self-hosted case the host and merchant are the same person.")]),e._v(" "),t("p",[t("strong",[e._v("Third-Party hosts")]),e._v(" - If a malicious third-party target a third-party host, and the host clicked on the malicious link, the host could potentially reveal the SSH key of their server allowing a malicious third-party to control it. This could be used in an escalating manner and get control of the server and steal the funds from the Lightning Network")]),e._v(" "),t("p",[t("strong",[e._v("Third-party host users")]),e._v(" - Merchants of third party hosts could potentially get their information xpub and email address exposed to an untrusted party if the third party host clicked on a malicious link.")]),e._v(" "),t("h2",{attrs:{id:"how-did-it-happen"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#how-did-it-happen"}},[e._v("#")]),e._v(" How did it happen:")]),e._v(" "),t("p",[e._v("For several of our features, we allowed users to inject HTML or styles into the rendered page. Some places were incorrectly sanitized allowing a maliciously registered party to inject javascript.")]),e._v(" "),t("p",[e._v("While investigating the extent of the issue we also found out that we were exposed to "),t("a",{attrs:{href:"https://github.com/aspnet/Announcements/issues/285",target:"_blank",rel:"noopener noreferrer"}},[e._v("CVE-2018–0784"),t("OutboundLink")],1),e._v(" found by security researcher at Microsoft ("),t("a",{attrs:{href:"http://twitter.com/blowdart",target:"_blank",rel:"noopener noreferrer"}},[e._v("@blowdart"),t("OutboundLink")],1),e._v(").")]),e._v(" "),t("p",[e._v("On top of it, it was a common pattern in the code to inject server-side variable into javascript scripts such as:")]),e._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("script"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("var")]),e._v(" name "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" “@Model"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("Name”"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("script"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v("\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[e._v("This is however unsafe, and we should have used "),t("a",{attrs:{href:"https://docs.microsoft.com/en-us/aspnet/core/security/cross-site-scripting?view=aspnetcore-2.2",target:"_blank",rel:"noopener noreferrer"}},[e._v("JavaScriptEncoder or JsonHelper"),t("OutboundLink")],1),e._v(" to encode properly.")]),e._v(" "),t("p",[e._v("Kevin Joensen of "),t("a",{attrs:{href:"https://www.doyensec.com/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Doyensec"),t("OutboundLink")],1),e._v(" provided a proof of concept that showed us how the attack can be executed.")]),e._v(" "),t("h2",{attrs:{id:"timeline"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#timeline"}},[e._v("#")]),e._v(" Timeline")]),e._v(" "),t("ul",[t("li",[e._v("2019-08-07 - Kevin Joensen disclosed the vulnerability.")]),e._v(" "),t("li",[e._v("2019-08-08 - Kevin Joensen provided the proof of concept.")]),e._v(" "),t("li",[e._v("2019-08-09 - Vulnerability has been patched and pull request submitted")]),e._v(" "),t("li",[e._v("2019-08-09 - Pull request reviewed and merged, making sure no breaking changes are made.")]),e._v(" "),t("li",[e._v("2019-08-09 - we reached out to publicly known third-party hosts and notified them about the issue, those who we reached out to updated their instances.")]),e._v(" "),t("li",[e._v("2019-08-10 - 1.0.3.127 released")]),e._v(" "),t("li",[e._v("2019-08-11 - We acknowledged the vulnerability and wrote "),t("a",{attrs:{href:"https://blog.btcpayserver.org/btcpay-1-0-3-127-released/",target:"_blank",rel:"noopener noreferrer"}},[e._v("a blog post,"),t("OutboundLink")],1),e._v(" urging affected users to update.")])]),e._v(" "),t("h2",{attrs:{id:"what-we-will-do"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#what-we-will-do"}},[e._v("#")]),e._v(" "),t("strong",[e._v("What we will do:")])]),e._v(" "),t("p",[e._v("To mitigate the escalation in case a bug is discovered in the future, we will make sure that the SSH key can’t be retrieve with an ajax request.")]),e._v(" "),t("h2",{attrs:{id:"recommendation"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#recommendation"}},[e._v("#")]),e._v(" Recommendation:")]),e._v(" "),t("p",[e._v("You "),t("strong",[e._v("don’t")]),e._v(" need to do anything if:")]),e._v(" "),t("ul",[t("li",[e._v("You are self-hosted (ie. not sharing your instance with merchants (users) you don’t trust)")]),e._v(" "),t("li",[e._v("If you have not clicked onto any link made by a merchant using your server")])]),e._v(" "),t("p",[e._v("If you do not fall in those category, and believe you may be "),t("strong",[e._v("affected")]),e._v(", besides updating, our recommendation is:")]),e._v(" "),t("ul",[t("li",[e._v("Edit ~/.ssh/authorized_keys on the host, and remove the ssh key of BTCPa and review that there is no key you do not recognize")]),e._v(" "),t("li",[e._v("Remove ~/.ssh/id_rsa_btcpay")])]),e._v(" "),t("p",[e._v("This SSH key is used by the “Update” button in BTCPay Server.")]),e._v(" "),t("p",[e._v("Regenerate keys and commit the changes:")]),e._v(" "),t("p",[e._v("ssh-keygen -t rsa -f /root/.ssh/id_rsa_btcpay -q -P “”\necho “# Key used by BTCPay Server” >> /root/.ssh/authorized_keys\ncat /root/.ssh/id_rsa_btcpay.pub >> /root/.ssh/authorized_keys\n. btcpay-setup.sh -i")]),e._v(" "),t("p",[e._v("If BTCPay Server gets enough funding in the future, we will definitively consider hiring "),t("a",{attrs:{href:"https://www.doyensec.com/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Doyensec"),t("OutboundLink")],1),e._v(" to perform a deeper security audit of our software.")]),e._v(" "),t("p",[e._v("We would like to thank Doyensec team for disclosing the vulnerability in a professional manner and making sure our users stay safe throught the process. We would like to invite other security researchers interested in reviewing the code of an open-source project, to take a look at our "),t("a",{attrs:{href:"https://github.com/btcpayserver/btcpayserver",target:"_blank",rel:"noopener noreferrer"}},[e._v("GitHub"),t("OutboundLink")],1),e._v(".")])])}),[],!1,null,null,null);t.default=s.exports}}]);